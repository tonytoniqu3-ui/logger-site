<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Messages reçus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;background:#0b0b10;color:#f7f7fb;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:820px;margin:auto;padding:20px}
    h1{font-size:28px;margin:8px 0 16px}
    .muted{color:#a3a3b2}
    .list{display:grid;gap:10px}
    .item{border:1px solid #262736;border-radius:12px;padding:12px;background:#0e0f16}
    .meta{font-size:12px;color:#a3a3b2;margin-bottom:6px;display:flex;gap:8px;flex-wrap:wrap}
    .user{font-weight:700;color:#fff}
    .msg{white-space:pre-wrap}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .btn{padding:8px 12px;border:1px solid #ffffff22;border-radius:10px;background:#ffffff10;color:#fff;text-decoration:none;cursor:pointer}
    input{padding:8px 10px;border-radius:10px;border:1px solid #262736;background:#0e0f16;color:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Messages reçus</h1>
      <div>
        <input id="limit" type="number" value="100" min="1" max="200" style="width:80px" />
        <button class="btn" id="refresh">Actualiser</button>
      </div>
    </div>
    <p class="muted">Affiche les derniers messages envoyés depuis le site (événement <code>message_sent</code>).</p>
    <div id="list" class="list" aria-live="polite"></div>
  </div>

  <script>
    const API = "/api/messages"; // même domaine
    const list = document.getElementById('list');
    const limit = document.getElementById('limit');

    function esc(s){ return (s||'').replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c])); }
    function fmtDate(iso){ try{ return new Date(iso).toLocaleString(); }catch{ return iso; } }

    async function load(){
      list.innerHTML = '<div class="muted">Chargement…</div>';
      try{
        const r = await fetch(API + '?limit=' + encodeURIComponent(limit.value || '100'));
        const data = await r.json();
        if(!data.ok){ list.innerHTML = '<div class="muted">Erreur de chargement.</div>'; return; }
        if(!data.items.length){ list.innerHTML = '<div class="muted">Aucun message pour le moment.</div>'; return; }
        list.innerHTML = data.items.map(it => `
          <div class="item">
            <div class="meta">
              <span class="user">@${esc(it.user || 'anonyme')}</span>
              <span>•</span>
              <span>${fmtDate(it.at)}</span>
            </div>
            <div class="msg">${esc(it.message)}</div>
          </div>
        `).join('');
      }catch(e){
        list.innerHTML = '<div class="muted">Erreur réseau.</div>';
      }
    }

    document.getElementById('refresh').addEventListener('click', load);
    setInterval(load, 10000); // auto-refresh 10s
    load();
  </script>
</body>
</html>
